#!/bin/sh
# IPSET LOADER WRAPPER (Fixed Logic)
# v.1.0.0
# 1. Creates empty set immediately.
# 2. Applies firewall rules immediately.
# 3. Updates content after delay.

IPSET_NAME="FirewallBlock"
LOG_TAG="Firewall_Boot"

start() {
    # 1. IMMEDIATE CREATION (Empty Set)
    # Create set immediately, otherwise 100-firewall.sh exits because it can't find it.
    if ! ipset list -n "$IPSET_NAME" >/dev/null 2>&1; then
        ipset create "$IPSET_NAME" hash:net hashsize 16384 maxelem 131072
        logger -t "$LOG_TAG" "Empty IPSET created immediately."
    fi

    # 2. APPLY FIREWALL RULES
    # Force loading iptables rules now that the set exists.
    if [ -x /opt/etc/ndm/netfilter.d/100-firewall.sh ]; then
        table=filter /opt/etc/ndm/netfilter.d/100-firewall.sh
        logger -t "$LOG_TAG" "Firewall rules applied (on empty set)."
    fi

    # 3. DELAYED UPDATE (Background)
    # Now we can wait for the download without blocking boot.
    (
        logger -t "$LOG_TAG" "Boot sequence detected. Waiting 180s for internet stability..."
        
        sleep 180
        
        if [ -x /opt/bin/update_blocklist.sh ]; then
            logger -t "$LOG_TAG" "Wait time over. Populating blocklist..."
            /opt/bin/update_blocklist.sh
        else
            logger -t "$LOG_TAG" "Error: /opt/bin/update_blocklist.sh not found!"
        fi
    ) &
}

stop() {
    # Save on shutdown
    if command -v ipset >/dev/null; then
        ipset save "$IPSET_NAME" > "/opt/etc/firewall_blocklist.save"
        logger -t "$LOG_TAG" "Blocklist saved successfully."
    fi
}

case "$1" in
    start|restart) start ;;
    stop) stop ;;
    *) echo "Usage: $0 {start|stop|restart}" ;;
esac

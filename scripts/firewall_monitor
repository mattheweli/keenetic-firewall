#!/bin/sh

# ==============================================================================
# KEENETIC FIREWALL MONITOR v3.2.0 (AUTOBAN EDITION)
# Features: 
#   - CONFIG: Reads /opt/etc/firewall.conf to toggle IPv6 monitoring.
#   - PERFORMANCE: Skips ip6tables calls if IPv6 is disabled.
#   - ADAPTIVE POLL: Scans fast (4s) when list is empty, slow (30s) when full.
#   - AUTOBAN: Now tracks dynamic AutoBan lists for real-time stats.
# ==============================================================================

export PATH=/opt/bin:/opt/sbin:/usr/bin:/usr/sbin:/bin:/sbin

# --- CONFIGURATION ---
CONF_FILE="/opt/etc/firewall.conf"
if [ -f "$CONF_FILE" ]; then . "$CONF_FILE"; else ENABLE_IPV6="true"; fi

# IPSet Names (Static)
IPSET_V4="FirewallBlock"
IPSET_V6="FirewallBlock6"

# IPSet Names (Dynamic/AutoBan)
IPSET_BAN="AutoBan"
IPSET_BAN6="AutoBan6"

DB_FILE="/opt/etc/firewall_stats.db"
REFRESH_RATE=2       # Base display update (seconds)

# Scan Cycles (multiplied by REFRESH_RATE)
SCAN_FAST=2          # 2 * 2s = 4s (When list is < 5 IPs)
SCAN_SLOW=15         # 15 * 2s = 30s (When list is full)

# Temp files for differential analysis
SNAP_START="/tmp/fw_mon_start.tmp"
SNAP_CURR="/tmp/fw_mon_curr.tmp"

# --- COLORS ---
ESC=$(printf '\033')
RESET="${ESC}[0m"
BOLD="${ESC}[1m"
RED="${ESC}[31m"; GREEN="${ESC}[32m"; YELLOW="${ESC}[33m"
BLUE="${ESC}[34m"; CYAN="${ESC}[36m"; DIM="${ESC}[2m"

# Cleanup on exit
cleanup() {
    rm -f "$SNAP_START" "$SNAP_CURR"
    echo -e "${RESET}"
    echo "Monitor stopped."
    exit 0
}
trap cleanup INT TERM

# --- HELPER FUNCTIONS ---
format_num() { echo "$1" | awk '{ printf "%'\''d", $1 }'; }

# Sums drops from Static List AND AutoBan List
get_combined_count() {
    # $1=cmd, $2=chain, $3=static_set, $4=ban_set
    $1 -L "$2" -v -x -n 2>/dev/null | awk -v s="$3" -v b="$4" '
        $0 ~ "match-set " s { sum += $1 }
        $0 ~ "match-set " b { sum += $1 }
        END { print sum+0 }
    '
}

# Extracts clean "IP COUNT" list from ipset
dump_ipset_clean() {
    ipset list "$1" 2>/dev/null | grep "packets" | sed -n 's/^\([^ ]*\) .*packets \([0-9]*\) .*/\1 \2/p'
}

# --- INIT SESSION ---
clear
echo -e "${BOLD}Initializing Session Monitor...${RESET}"
echo -e "${DIM}Taking baseline snapshot (Mode: IPv6=$ENABLE_IPV6)...${RESET}"

# 1. Take Baseline Snapshot (Start of Session)
# We now dump BOTH static and dynamic lists to catch all attackers
: > "$SNAP_START"
{
    dump_ipset_clean "$IPSET_V4"
    dump_ipset_clean "$IPSET_BAN"
    if [ "$ENABLE_IPV6" = "true" ]; then 
        dump_ipset_clean "$IPSET_V6"
        dump_ipset_clean "$IPSET_BAN6"
    fi
} >> "$SNAP_START"

# 2. Initial Counters (Combined Static + Dynamic)
START_V4_IN=$(get_combined_count "iptables" "BLOCKLIST_IN" "$IPSET_V4" "$IPSET_BAN")
START_V4_FW=$(get_combined_count "iptables" "BLOCKLIST_FWD" "$IPSET_V4" "$IPSET_BAN")
START_TOTAL_V4=$((START_V4_IN + START_V4_FW))

START_TOTAL_V6=0
if [ "$ENABLE_IPV6" = "true" ]; then
    START_V6_IN=$(get_combined_count "ip6tables" "BLOCKLIST_IN6" "$IPSET_V6" "$IPSET_BAN6")
    START_V6_FW=$(get_combined_count "ip6tables" "BLOCKLIST_FWD6" "$IPSET_V6" "$IPSET_BAN6")
    START_TOTAL_V6=$((START_V6_IN + START_V6_FW))
fi

CYCLE=0
CURRENT_LIMIT=0 # Force immediate scan on start
TOP5_CACHE=""
LAST_SCAN_TIME="Pending..."

# --- MAIN LOOP ---
while true; do
    # 1. Light Task: Global Counters (Instant)
    CUR_V4_IN=$(get_combined_count "iptables" "BLOCKLIST_IN" "$IPSET_V4" "$IPSET_BAN")
    CUR_V4_FW=$(get_combined_count "iptables" "BLOCKLIST_FWD" "$IPSET_V4" "$IPSET_BAN")
    CUR_TOT_V4=$((CUR_V4_IN + CUR_V4_FW))
    SESS_V4=$((CUR_TOT_V4 - START_TOTAL_V4))

    CUR_TOT_V6=0; SESS_V6=0
    if [ "$ENABLE_IPV6" = "true" ]; then
        CUR_V6_IN=$(get_combined_count "ip6tables" "BLOCKLIST_IN6" "$IPSET_V6" "$IPSET_BAN6")
        CUR_V6_FW=$(get_combined_count "ip6tables" "BLOCKLIST_FWD6" "$IPSET_V6" "$IPSET_BAN6")
        CUR_TOT_V6=$((CUR_V6_IN + CUR_V6_FW))
        SESS_V6=$((CUR_TOT_V6 - START_TOTAL_V6))
    fi
    
    # 2. Heavy Task: Differential Scan (Adaptive Frequency)
    if [ "$CYCLE" -ge "$CURRENT_LIMIT" ]; then
        STATUS_TXT="Analyzing..."
        
        # A. Grab Current State (All Lists)
        : > "$SNAP_CURR"
        {
            dump_ipset_clean "$IPSET_V4"
            dump_ipset_clean "$IPSET_BAN"
            if [ "$ENABLE_IPV6" = "true" ]; then 
                dump_ipset_clean "$IPSET_V6"
                dump_ipset_clean "$IPSET_BAN6"
            fi
        } >> "$SNAP_CURR"
        
        # B. Calculate Delta
        RAW_TOP=$(awk 'FNR==NR { start[$1]=$2; next } { diff = $2 - start[$1]; if (diff > 0) print $1, diff }' "$SNAP_START" "$SNAP_CURR" | sort -rn -k2 | head -n 5)
        
        # C. Adaptive Logic
        ITEM_COUNT=$(echo "$RAW_TOP" | grep -c "^")
        if [ "$ITEM_COUNT" -lt 5 ]; then
            CURRENT_LIMIT=$SCAN_FAST; FREQ_MSG="Fast Mode (4s)"
        else
            CURRENT_LIMIT=$SCAN_SLOW; FREQ_MSG="Eco Mode (30s)"
        fi
        
        TOP5_CACHE=""
        if [ -n "$RAW_TOP" ]; then
            IFS=$'\n'
            for line in $RAW_TOP; do
                IP=$(echo "$line" | awk '{print $1}')
                CNT=$(echo "$line" | awk '{print $2}')
                
                CC=""
                if [ -f "$DB_FILE" ]; then
                    CLEAN_IP=$(echo "$IP" | cut -d'/' -f1)
                    CC=$(sqlite3 "$DB_FILE" "SELECT country FROM ip_info WHERE ip='$CLEAN_IP' LIMIT 1;" 2>/dev/null)
                fi
                [ -z "$CC" ] && CC="--"
        
                COL=$GREEN
                [ "$CNT" -gt 20 ] && COL=$YELLOW
                [ "$CNT" -gt 100 ] && COL=$RED
                
                TOP5_CACHE="${TOP5_CACHE}\n   ${CYAN}${IP}${RESET}  \t[${COL}+${CNT}${RESET}] ${DIM}${CC}${RESET}"
            done
            unset IFS
        else
            TOP5_CACHE="\n   ${DIM}(No active attacks in this session)${RESET}"
        fi
        
        LAST_SCAN_TIME=$(date "+%H:%M:%S")
        CYCLE=0
    else
        STATUS_TXT="Live (${FREQ_MSG})"
        CYCLE=$((CYCLE + 1))
    fi

    # 3. DRAW UI
    clear
    echo -e "${BOLD}${BLUE}╔════════════════════════════════════════════════╗${RESET}"
    echo -e "${BOLD}${BLUE}║    KEENETIC FIREWALL SESSION MONITOR v3.2.0    ║${RESET}"
    echo -e "${BOLD}${BLUE}╚════════════════════════════════════════════════╝${RESET}"
    echo ""
    
    if [ "$ENABLE_IPV6" = "true" ]; then
        printf " %-20s ${BOLD}%-15s ${BOLD}%-15s${RESET}\n" "" "IPv4" "IPv6"
        echo -e "${DIM} ------------------------------------------------${RESET}"
        printf " Total Drops        : ${DIM}%-15s ${DIM}%-15s${RESET}\n" "$(format_num $CUR_TOT_V4)" "$(format_num $CUR_TOT_V6)"
        printf " Session Active     : ${BOLD}${RED}+%-14s ${RED}+%-14s${RESET}\n" "$(format_num $SESS_V4)" "$(format_num $SESS_V6)"
    else
        printf " %-20s ${BOLD}%-15s${RESET}\n" "" "IPv4"
        echo -e "${DIM} ------------------------------------------------${RESET}"
        printf " Total Drops        : ${DIM}%-15s${RESET}\n" "$(format_num $CUR_TOT_V4)"
        printf " Session Active     : ${BOLD}${RED}+%-14s${RESET}\n" "$(format_num $SESS_V4)"
    fi
    echo -e "${DIM} ------------------------------------------------${RESET}"
    
    echo ""
    echo -e "${YELLOW} [ TOP ATTACKERS (Static + AutoBan) ] ${DIM}(Upd: $LAST_SCAN_TIME)${RESET}"
    echo -e "$TOP5_CACHE"
    echo ""
    echo -e "${DIM} ------------------------------------------------${RESET}"
    echo -e " ${BOLD}Status:${RESET} $STATUS_TXT"
    echo -e " ${DIM}Press [Ctrl+C] to exit.${RESET}"

    sleep $REFRESH_RATE
done
